<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:OpenTaskManager.ViewModels"
             xmlns:models="using:OpenTaskManager.Models"
             mc:Ignorable="d"
             x:Class="OpenTaskManager.Views.UsersView"
             x:DataType="vm:MainViewModel">

    <Grid RowDefinitions="Auto,*">
        <!-- Toolbar -->
        <Border Grid.Row="0" Background="#1F1F1F" Padding="16,10" BorderBrush="#2D2D2D" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="Users" FontSize="24" FontWeight="SemiBold" Foreground="#FFFFFF"/>
                </StackPanel>

                <!-- Search Box (centered in header) -->
                <Border Grid.Column="1" Background="#383838" CornerRadius="4"
                    Margin="0" MaxWidth="520" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Grid ColumnDefinitions="Auto,*">
                        <PathIcon Grid.Column="0" Width="14" Height="14" Margin="10,0,6,0"
                                  Foreground="#9E9E9E"
                                  Data="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                        <TextBox Grid.Column="1" Text="{Binding UserSearchText}" 
                                 Watermark="Type a user to search..." BorderThickness="0"
                                 Background="Transparent" Foreground="#FFFFFF" 
                                 Padding="6,8" HorizontalAlignment="Stretch" MinWidth="300"/>
                    </Grid>
                </Border>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Classes="actionButton" Command="{Binding RunNewTaskCommand}" Padding="8,6" Margin="0">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Width="14" Height="14" Foreground="#FFFFFF"
                                      Data="M20 14H14V20H10V14H4V10H10V4H14V10H20V14Z"/>
                            <TextBlock Text="Run new task"/>
                        </StackPanel>
                    </Button>
                    <Button Classes="actionButton" Command="{Binding DisconnectUserCommand}" Padding="8,6" Margin="0"
                            IsEnabled="{Binding SelectedUser, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <PathIcon Width="14" Height="14" Foreground="#FFFFFF"
                                      Data="M2,5.27L3.28,4L20,20.72L18.73,22L14.73,18H7V16.5C7,14.17 10.33,13 13,13C13.5,13 14,13.05 14.5,13.14L10.73,9.37C10.5,9.44 10.26,9.5 10,9.5A3.5,3.5 0 0,1 6.5,6C6.5,5.74 6.56,5.5 6.63,5.27L2,5.27M10,4A3.5,3.5 0 0,1 13.5,7.5C13.5,8.17 13.32,8.79 13,9.32L11.32,7.64C11.26,7.45 11.16,7.28 11.03,7.13L10.88,6.97C10.73,6.84 10.56,6.74 10.37,6.68L8.68,5C9.21,4.68 9.83,4.5 10.5,4.5L10,4M17,7.5A3.5,3.5 0 0,1 20.5,11C20.5,12.32 19.75,13.46 18.67,14.03L17.18,12.54C17.68,12.21 18,11.64 18,11A1.5,1.5 0 0,0 16.5,9.5C15.87,9.5 15.3,9.82 14.97,10.32L13.46,8.81C14.04,7.75 15.18,7 16.5,7L17,7.5Z"/>
                            <TextBlock Text="Disconnect"/>
                        </StackPanel>
                    </Button>
                    <!-- Manage user accounts button removed per request -->
                </StackPanel>
            </Grid>
        </Border>

        <!-- Users List -->
        <Grid Grid.Row="1">
            <!-- Column Headers -->
            <Grid RowDefinitions="Auto,*">
                <Border Grid.Row="0" Background="#252525" Padding="0,8" BorderBrush="#3D3D3D" BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="40,200,100,80,100,100,100">
                        <TextBlock Grid.Column="1" Text="User" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="2" Text="Status" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="3" Text="CPU" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                        <TextBlock Grid.Column="4" Text="Memory" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                        <TextBlock Grid.Column="5" Text="Disk" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                        <TextBlock Grid.Column="6" Text="Network" Foreground="#9E9E9E" FontSize="12" FontWeight="SemiBold" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                    </Grid>
                </Border>

                <!-- Users TreeView -->
                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding FilteredUsers}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="models:UserInfo">
                                <StackPanel>
                                    <!-- User Row -->
                                    <Border Background="#1E1E1E" 
                                            Padding="0,6" 
                                            BorderBrush="#3D3D3D" 
                                            BorderThickness="0,0,0,1"
                                            PointerPressed="OnUserRowPressed">
                                        <Grid ColumnDefinitions="40,200,100,80,100,100,100">
                                            <!-- Expand Button -->
                                            <Button Grid.Column="0" 
                                                    Background="Transparent" 
                                                    BorderThickness="0"
                                                    Padding="8,4"
                                                    Command="{Binding $parent[ItemsControl].((vm:MainViewModel)DataContext).ToggleUserExpandedCommand}"
                                                    CommandParameter="{Binding}">
                                                <Panel>
                                                    <!-- Collapsed arrow (right-pointing) -->
                                                    <PathIcon Width="12" Height="12" Foreground="#9E9E9E"
                                                              Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"
                                                              IsVisible="{Binding !IsExpanded}"/>
                                                    <!-- Expanded arrow (down-pointing) -->
                                                    <PathIcon Width="12" Height="12" Foreground="#9E9E9E"
                                                              Data="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"
                                                              IsVisible="{Binding IsExpanded}"/>
                                                </Panel>
                                            </Button>
                                            
                                            <!-- User Icon and Name -->
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                <Border Background="#0078D4" CornerRadius="12" Width="24" Height="24">
                                                    <PathIcon Width="14" Height="14" Foreground="#FFFFFF"
                                                              Data="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"
                                                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                                <TextBlock Text="{Binding UserName}" Foreground="#FFFFFF" FontSize="13" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding ProcessCountFormatted}" Foreground="#9E9E9E" FontSize="12" VerticalAlignment="Center"/>
                                            </StackPanel>
                                            
                                            <!-- Status -->
                                            <TextBlock Grid.Column="2" Text="{Binding Status}" Foreground="#FFFFFF" FontSize="13" VerticalAlignment="Center"/>
                                            
                                            <!-- CPU -->
                                            <TextBlock Grid.Column="3" Text="{Binding CpuFormatted}" Foreground="#FFFFFF" FontSize="13" 
                                                       VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                            
                                            <!-- Memory -->
                                            <TextBlock Grid.Column="4" Text="{Binding MemoryFormatted}" Foreground="#FFFFFF" FontSize="13" 
                                                       VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                            
                                            <!-- Disk -->
                                            <TextBlock Grid.Column="5" Text="{Binding DiskFormatted}" Foreground="#FFFFFF" FontSize="13" 
                                                       VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                            
                                            <!-- Network -->
                                            <TextBlock Grid.Column="6" Text="{Binding NetworkFormatted}" Foreground="#FFFFFF" FontSize="13" 
                                                       VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Expanded Process List -->
                                    <ItemsControl ItemsSource="{Binding Processes}" IsVisible="{Binding IsExpanded}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="models:ProcessInfo">
                                                <Border Background="#161616" Padding="0,4" BorderBrush="#2D2D2D" BorderThickness="0,0,0,1">
                                                    <Grid ColumnDefinitions="40,200,100,80,100,100,100" Margin="20,0,0,0">
                                                        <!-- Uniform process extension puzzle icon -->
                                                        <PathIcon Grid.Column="0" Width="16" Height="16" Foreground="#9E9E9E" Margin="12,0,0,0"
                                                                  Data="M20.5,11H19V7c0-1.1-0.9-2-2-2h-4V3.5C13,2.12,11.88,1,10.5,1S8,2.12,8,3.5V5H4c-1.1,0-1.99,0.9-1.99,2v3.8H3.5c1.38,0,2.5,1.12,2.5,2.5s-1.12,2.5-2.5,2.5H2v4c0,1.1,0.9,2,2,2h4v1.5c0,1.38,1.12,2.5,2.5,2.5s2.5-1.12,2.5-2.5V19h4c1.1,0,1.99-0.9,1.99-2v-4.5h1.5c1.38,0,2.5-1.12,2.5-2.5S21.88,11,20.5,11z"
                                                                  VerticalAlignment="Center" HorizontalAlignment="Left"/>
                                                        <TextBlock Grid.Column="1" Text="{Binding Name}" Foreground="#B0B0B0" FontSize="12" VerticalAlignment="Center"/>
                                                        <TextBlock Grid.Column="2" Text="{Binding Status}" Foreground="#808080" FontSize="12" VerticalAlignment="Center"/>
                                                        <TextBlock Grid.Column="3" Text="{Binding CpuFormatted}" Foreground="#B0B0B0" FontSize="12" 
                                                                   VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                                        <TextBlock Grid.Column="4" Text="{Binding MemoryFormatted}" Foreground="#B0B0B0" FontSize="12" 
                                                                   VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                                        <TextBlock Grid.Column="5" Text="{Binding DiskReadFormatted}" Foreground="#B0B0B0" FontSize="12" 
                                                                   VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                                        <TextBlock Grid.Column="6" Text="{Binding NetworkSendFormatted}" Foreground="#B0B0B0" FontSize="12" 
                                                                   VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,12,0"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
